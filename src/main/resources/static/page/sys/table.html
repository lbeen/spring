<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>数据表配置</title>
    <link rel="stylesheet" href="../../common/element/index.css">
    <link rel="stylesheet" href="../../common/css/common.css">
    <script src="../../common/vue/vue.js"></script>
    <script src="../../common/vue/vue-resource.js"></script>
    <script src="../../common/element/index.js"></script>
    <script src="../../common/js/jquery3.5.1.js"></script>
    <script src="../../common/js/common.js"></script>
    <script src="../../common/vue/vueComponent.js"></script>
</head>
<body>
<div id="app">
    <page-table url="table/getPage" :param="param">
        <slot slot="search" slot-scope="scope">
            <el-form :inline="true">
                <el-form-item label="表名">
                    <el-input v-model="param.tableName" size="small" clearable></el-input>
                </el-form-item>
                <el-form-item label="表描述">
                    <el-input v-model="param.tableDesc" size="small" clearable></el-input>
                </el-form-item>
                <el-form-item label="类型">
                    <el-select v-model="param.dbId" placeholder="请选择数据库" size="small" clearable>
                        <el-option v-for="item in dbOptions" :label="item.label" :value="item.value"
                                   size="small">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button id="search" type="primary" @click="scope.loadData(1)" size="small">查询</el-button>
                    <el-button type="success" @click="addTable" size="small">新增</el-button>
                    <el-button type="success" @click="refreshTableCache" size="small">刷新缓存</el-button>
                </el-form-item>
            </el-form>
        </slot>
        <slot slot="table">
            <el-table-column label="表名" prop="tableName" label="IP" width="180"></el-table-column>
            <el-table-column label="表描述" prop="tableDesc"></el-table-column>
            <el-table-column label="数据库" prop="dbDesc" width="220"></el-table-column>
            <el-table-column label="操作">
                <template slot-scope="scope">
                    <el-button type="success" @click="editTable(scope.row.id)" size="small">编辑</el-button>
                    <el-button type="danger" @click="deleteTable(scope.row)" size="small">删除</el-button>
                    <el-button type="primary" @click="editColumns(scope.row.id)" size="small">编辑字段</el-button>
                </template>
            </el-table-column>
        </slot>
    </page-table>

    <el-dialog :title="addFormTitle" :visible.sync="isShowAddForm" width="500px">
        <el-form :model="addForm" label-width="100px">
            <el-form-item label="表名">
                <el-input v-model="addForm.tableName" size="small" placeholder="请输入表名"></el-input>
            </el-form-item>
            <el-form-item label="表描述">
                <el-input v-model="addForm.tableDesc" size="small" placeholder="请输入表描述"></el-input>
            </el-form-item>
            <el-form-item label="数据库">
                <el-select v-model="addForm.dbId" placeholder="请选择数据库" style="width: 100%" size="small" clearable>
                    <el-option v-for="item in dbOptions" :label="item.label" :value="item.value"
                               size="small">
                    </el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="isShowAddForm = false">取 消</el-button>
            <el-button type="primary" @click="saveTable">保 存</el-button>
        </div>
    </el-dialog>

    <el-dialog title="删除" :visible.sync="isShowDeleteConfirm" width="30%">
        <span>{{deleteMsg}}</span>
        <span slot="footer" class="dialog-footer">
        <el-button @click="isShowDeleteConfirm = false">取 消</el-button>
        <el-button type="primary" @click="confirmTable">确 定</el-button>
        </span>
    </el-dialog>

    <el-dialog title="字段说明" :visible.sync="showColumnsTable">
        <el-table :data="tableColumns" border max-height="500" :cell-style="{'text-align': 'center'}"
                  :header-cell-style="{'text-align': 'center','background-color': '#f5f7fa'}">
            <el-table-column label="序号" width="50" type="index"></el-table-column>
            <el-table-column label="字段" width="150">
                <template slot-scope="scope">
                    <el-input v-model="scope.row.columnName" size="small" placeholder="请输入字段名"></el-input>
                </template>
            </el-table-column>
            <el-table-column label="描述">
                <template slot-scope="scope">
                    <el-input v-model="scope.row.columnDesc" size="small" placeholder="请输入字段描述"></el-input>
                </template>
            </el-table-column>
            <el-table-column label="字段类型">
                <template slot-scope="scope">
                    <el-select v-model="scope.row.columnType" placeholder="请选择字段类型" size="small" clearable>
                        <el-option v-for="item in columnTypeOption" :label="item.label" :value="item.value"></el-option>
                    </el-select>
                </template>
            </el-table-column>
            <el-table-column label="删除" width="50">
                <template slot-scope="scope">
                    <i class="el-icon-delete" style="color: red;cursor: pointer;"
                       @click="deleteColumn(scope.$index)"></i>
                </template>
            </el-table-column>
        </el-table>
        <div slot="footer" class="dialog-footer">
            <el-button @click="showColumnsTable = false" size="small">取 消</el-button>
            <el-button type="success" @click="addTableColumn" size="small">新增</el-button>
            <el-button type="primary" @click="saveTableColumns" size="small">保 存</el-button>
        </div>
    </el-dialog>
</div>
</body>
<script>
    const app = new Vue({
        el: '#app',
        data: {
            param: {
                dbId: '',
                tableName: '',
                tableDesc: '',
            },
            dbOptions: [],

            isShowAddForm: false,
            formInputWidth: '120px',
            addFormTitle: '',
            addForm: {
                id: '',
                tableName: '',
                tableDesc: '',
                dbId: ''
            },

            isShowDeleteConfirm: false,
            deleteId: '',
            deleteMsg: '',

            showColumnsTable: false,
            currentTableId: '',
            tableColumns: [],

            columnTypeOption: []
        },
        created: function () {
            this.getDbs();
            this.getColumnTypeOption();
        },
        methods: {
            getDbs: function () {
                this.httpGet('database/getDbPage', {
                    pageSize: 100,
                    currentPage: 1
                }, function (data) {
                    if (data) {
                        for (let i = 0; i < data.list.length; i++) {
                            app.dbOptions.push({
                                label: data.list[i].dbDesc,
                                value: data.list[i].id,
                            });
                        }
                    }
                });
            },
            getColumnTypeOption: function () {
                let self = this;
                this.httpGet('dic/getUsedDics', {type: 'columnType'}, function (data) {
                    if (data) {
                        for (let i = 0; i < data.length; i++) {
                            self.columnTypeOption.push({
                                label: data[i].name,
                                value: data[i].code
                            });
                        }
                    }
                });
            },
            addTable: function () {
                this.resetAddForm();
                this.addFormTitle = '新增表';
                this.isShowAddForm = true;
            },
            editTable: function (id) {
                this.resetAddForm();
                this.isShowAddForm = true;
                this.addFormTitle = '编辑表';

                this.httpGet('table/getTableById', {
                    id: id
                }, function (data) {
                    if (data) {
                        app.addForm = {
                            id: data.id,
                            tableName: data.tableName,
                            tableDesc: data.tableDesc,
                            dbId: data.dbId
                        }
                    }
                });
            },
            saveTable: function () {
                if (!this.addForm.tableName) {
                    this.$message.error('请输入表名');
                    return;
                }
                if (!this.addForm.tableDesc) {
                    this.$message.error('请输入表描述');
                    return;
                }
                if (!this.addForm.dbId) {
                    this.$message.error('请选择数据库');
                    return;
                }
                this.postEmulateJSON('table/saveTable', {
                    id: this.addForm.id,
                    tableName: this.addForm.tableName,
                    tableDesc: this.addForm.tableDesc,
                    dbId: this.addForm.dbId
                }, function () {
                    $('#search').click();
                    app.isShowAddForm = false;
                });
            },
            resetAddForm: function () {
                this.addForm = {
                    id: '',
                    ip: '',
                    port: '',
                    dbType: '',
                    dbName: '',
                    used: false
                }
            },
            deleteTable: function (row) {
                this.isShowDeleteConfirm = true;
                this.deleteId = row.id;
                this.deleteMsg = '确认删除表【' + row.tableName + '】？';
            },
            confirmTable: function () {
                if (!this.deleteId) {
                    app.$message.error('请选择要删除的表');
                    return;
                }
                this.postEmulateJSON('table/deleteTable', {id: this.deleteId}, function () {
                    $('#search').click();
                    app.isShowDeleteConfirm = false;
                });
            },
            refreshTableCache: function () {
                this.httpGet('table/refreshTableCache');
            },
            editColumns: function (tableId) {
                this.currentTableId = tableId;
                this.tableColumns = [];
                this.showColumnsTable = true;
                this.httpGet('table/getColumnsByTableId', {
                    tableId: tableId
                }, function (data) {
                    debugger
                    if (data) {
                        app.tableColumns = data;
                    }
                });
            },
            addTableColumn: function () {
                this.tableColumns.push({});
            },
            deleteColumn: function (columnIndex) {
                var tableColumns = [];
                for (var i = 0; i < this.tableColumns.length; i++) {
                    if (i !== columnIndex) {
                        tableColumns.push(this.tableColumns[i]);
                    }
                }
                this.tableColumns = tableColumns;
            },
            saveTableColumns: function () {
                var tableColumns = [];
                for (var i = 0; i < this.tableColumns.length; i++) {
                    var tableColumn = this.tableColumns[i];
                    if (!tableColumn.columnName || !tableColumn.columnDesc || !tableColumn.columnType) {
                        this.$message.error('请完善字段信息');
                        return;
                    }
                    tableColumns.push({
                        columnName: tableColumn.columnName,
                        columnDesc: tableColumn.columnDesc,
                        columnType: tableColumn.columnType
                    });
                }
                if (tableColumns.length === 0) {
                    this.$message.error('请添加字段信息');
                    return;
                }

                this.httpPost('table/insertColumns', {
                    tableId: this.currentTableId,
                    tableColumns: this.tableColumns
                }, function () {
                    $('#search').click();
                    app.showColumnsTable = false;
                });
            }
        }
    })
</script>
</html>
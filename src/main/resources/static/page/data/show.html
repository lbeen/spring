<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>数据查询</title>
    <link rel="stylesheet" href="../../common/element/index.css">
    <link rel="stylesheet" href="../../common/css/common.css">
    <script src="../../common/vue/vue.js"></script>
    <script src="../../common/vue/vue-resource.js"></script>
    <script src="../../common/element/index.js"></script>
    <script src="../../common/js/jquery3.5.1.js"></script>
    <script src="../../common/js/common.js"></script>
    <script src="../../common/vue/vueComponent.js"></script>
</head>
<body>
<div id="app">
    <page-table url="data/getData" :param-fun="paramFun">
        <slot slot="search" slot-scope="scope">
            <el-form :inline="true">
                <el-form-item label="数据表">
                    <el-select v-model="table" placeholder="请选择数据表" style="width: 100%" size="small" clearable
                               filterable @change="tableChange">
                        <el-option v-for="item in tableOptions" :label="item.label" :value="item.value"
                                   size="small"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="showConditions = true" size="small">查询条件</el-button>
                    <el-button id="search" type="primary" @click="search(scope)" size="small">查询</el-button>
                </el-form-item>
            </el-form>
        </slot>
        <slot slot="table">
            <el-table-column v-for="item in heads" :label="item.columnDesc" :prop="item.columnName" min-width="150">
            </el-table-column>
        </slot>
    </page-table>
    <el-dialog title="查询条件" :visible.sync="showConditions">
        <el-table :data="conditions" border max-height="500">
            <el-table-column label="序号" width="50" type="index"></el-table-column>
            <el-table-column label="字段" width="150">
                <template slot-scope="scope">
                    <el-select v-model="scope.row.id" placeholder="请选择字段" style="width: 100%" size="small"
                               clearable @change="selectColumn">
                        <el-option v-for="item in selectHeads" :label="item.columnDesc" :value="item.id" size="small">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>
            <el-table-column label="值">
                <template slot-scope="scope">
                    <el-input v-model="scope.row.columnValue" size="small" placeholder="请输入字段值" style="width: 100%"
                              v-if="scope.row.columnType == 'string'">
                    </el-input>
                    <el-input-number v-model="scope.row.columnValue" size="small" :step="1" placeholder="请输入字段值"
                                     style="width: 100%"
                                     v-if="scope.row.columnType == 'int' || scope.row.columnType == 'long' || scope.row.columnType == 'double'">
                    </el-input-number>
                </template>
            </el-table-column>
            <el-table-column label="删除" width="50">
                <template slot-scope="scope">
                    <i class="el-icon-delete" style="color: red;cursor: pointer;"
                       @click="deleteCondition(scope.$index)"></i>
                </template>
            </el-table-column>
        </el-table>
        <div slot="footer" class="dialog-footer">
            <el-button type="success" @click="addCondition" size="small">新 增</el-button>
            <el-button type="primary" @click="conditionSearch" size="small">查询</el-button>
        </div>
    </el-dialog>
</div>
</body>
<script>
    const app = new Vue({
        el: '#app',
        data: {
            tableOptions: [],

            table: '',
            selectHeads: [],

            showConditions: false,
            conditions: [],

            heads: [],
        },
        created: function () {
            this.getTables();
        },
        methods: {
            getTables: function () {
                this.httpGet('table/getPage', {
                    pageSize: 100,
                    currentPage: 1
                }, function (data) {
                    if (data) {
                        for (let i = 0; i < data.list.length; i++) {
                            var table = data.list[i];
                            app.tableOptions.push({
                                label: table.tableName,
                                value: table.tableName,
                                id: table.id,
                            });
                        }
                    }
                });
            },
            tableChange: function (value) {
                this.conditions = [];
                this.selectHeads = [];
                for (let i = 0; i < this.tableOptions.length; i++) {
                    let option = this.tableOptions[i];
                    if (option.label === value) {
                        this.httpGet('table/getColumnsByTableId', {
                            tableId: option.id
                        }, function (data) {
                            if (data) {
                                app.selectHeads = data;
                            }
                        });
                        return;
                    }
                }
            },
            addCondition: function () {
                this.conditions.push({});
            },
            deleteCondition: function (index) {
                let conditions = [];
                for (let i = 0; i < this.conditions.length; i++) {
                    if (i !== index) {
                        conditions.push(this.conditions[i]);
                    }
                }
                this.conditions = conditions;
            },
            selectColumn:function(id){
                for (let i = 0; i < this.selectHeads.length; i++) {
                    let head = this.selectHeads[i];
                    if (head.id === id) {
                        for (let j = 0; j < this.conditions.length; j++) {
                            let condition = this.conditions[j];
                            if (condition.id === id) {
                                condition.columnType = head.columnType;
                                condition.columnName = head.columnName;
                            }
                        }
                        break;
                    }
                }
            },
            conditionSearch: function () {
                this.showConditions = false;
                $('#search').click();
            },
            paramFun: function () {
                return {
                    table: this.table,
                    conditions: JSON.stringify(this.conditions)
                };
            },
            search: function (scope) {
                this.heads = this.selectHeads;
                scope.loadData(1);
            }
        }
    })
</script>
</html>
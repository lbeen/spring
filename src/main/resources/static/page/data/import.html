<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../../common/element/index.css">
    <link rel="stylesheet" href="../../common/css/common.css">
    <script src="../../common/vue/vue.js"></script>
    <script src="../../common/vue/vue-resource.js"></script>
    <script src="../../common/element/index.js"></script>
    <script src="../../common/js/jquery3.5.1.js"></script>
    <script src="../../common/js/common.js"></script>
</head>
<body>
<div id="app" v-loading.fullscreen.lock="fullscreenLoading">
    <el-row>
        <el-form :inline="true">
            <el-form-item :label="fileName">
                <el-button type="success" @click="isShowUpload = true" size="small">上传文件</el-button>
            </el-form-item>
            <el-form-item label="数据表">
                <el-select v-model="tableId" placeholder="请选择数据表" style="width: 100%" size="small" clearable filterable>
                    <el-option v-for="item in tableOptions" :label="item.label" :value="item.value"
                               size="small"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="分列符">
                <el-select v-model="split" placeholder="请选择分列符" style="width: 100%" size="small" clearable>
                    <el-option v-for="item in splitOptions" :label="item.label" :value="item.value"
                               size="small"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="预览数量">
                <el-input-number v-model="previewCount" size="small" :min="1" :max="100" :step="10"></el-input-number>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="preview" size="small">预览</el-button>
                <el-button type="success" @click="saveData" size="small">保存</el-button>
                <el-button type="success" @click="showProgress = true" size="small">进度条</el-button>
            </el-form-item>
        </el-form>
    </el-row>

    <el-table :data="lines" border :cell-style="{'text-align': 'center'}" max-height="600"
              :header-cell-style="{'text-align': 'center','background-color': '#f5f7fa'}">
        <el-table-column v-for="(item,index)  in maxLineSize" min-width="150">
            <template slot="header" slot-scope="scope">
                <el-select v-model="heads[index]" placeholder="请选择表头" style="width: 100%" size="small" clearable>
                    <el-option v-for="item in columns" :label="item.label" :value="item.value"></el-option>
                </el-select>
            </template>
            <template slot-scope="scope">{{scope.row[index]}}</template>
        </el-table-column>
    </el-table>

    <el-dialog title="上传文件" :visible.sync="isShowUpload" width="30%">
        <el-form label-width="100px">
            <el-form-item label="文件">
                <el-upload ref="upload" class="upload-demo" :action="projectName + 'data/upload'"
                           :on-success="handleUploadSuccess"
                           :multiple="false" :auto-upload="false">
                    <el-button slot="trigger" size="small" type="primary">选取文件</el-button>
                </el-upload>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button size="small" @click="isShowUpload = false">取 消</el-button>
            <el-button type="primary" size="small" @click="submitUpload">确 定</el-button>
        </span>
    </el-dialog>

    <el-dialog title="导入进度" :visible.sync="showProgress" before-close width="180px" :before-close="beforeClose" :show-close="false">
        <el-progress type="circle" :percentage="percentage"></el-progress>
<!--        <el-button type="primary" size="small" @click="submitUpload">确 定</el-button>-->
<!--            <el-button type="primary" size="small" @click="submitUpload">确 定</el-button>-->

        <span slot="footer" class="dialog-footer">
<!--            <el-button size="small" @click="isShowUpload = false">取 消</el-button>-->
            <el-button type="primary" size="small" @click="showProgress == false">确 定</el-button>
        </span>
    </el-dialog>
</div>
</body>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            showProgress:false,
            percentage:0,

            tableId: '',
            fileName: '',
            tmpFileName: '',
            split: '',
            previewCount: 50,

            tableOptions: [],
            splitOptions: [{
                label: '英文逗号',
                value: 'comma'
            }, {
                label: '制表符',
                value: 'tab'
            }],

            maxLineSize: 0,
            heads: [],
            columns: [],
            lines: [],

            isShowUpload: false,
            fullscreenLoading: false
        },
        created: function () {
            this.getTables();
        }
        ,
        methods: {
            beforeClose:function(){

            },
            getTables: function () {
                this.httpGet('table/getPage', {
                    pageSize: 100,
                    currentPage: 1
                }, function (data) {
                    if (data) {
                        for (let i = 0; i < data.list.length; i++) {
                            var table = data.list[i];
                            app.tableOptions.push({
                                label: table.tableName,
                                value: table.id,
                            });
                        }
                    }
                });
            }
            ,
            submitUpload() {
                this.$refs.upload.submit();
            }
            ,
            handleUploadSuccess: function (res) {
                if (res.code !== 0) {
                    this.$message.error(res.msg);
                    return;
                }
                this.fileName = res.data.fileName;
                this.tmpFileName = res.data.tmpFileName;
                this.isShowUpload = false;
            }
            ,
            preview: function () {
                if (!this.tmpFileName) {
                    this.$message.error('请上传文件');
                    return;
                }
                if (!this.tableId) {
                    this.$message.error('请选择数据表');
                    return;
                }

                this.httpGet('data/preview', {
                    tmpFileName: this.tmpFileName,
                    tableId: this.tableId,
                    split: this.split,
                    previewCount: this.previewCount
                }, function (res) {
                    app.maxLineSize = 0;
                    app.columns = [];
                    app.heads = [];
                    if (res.code === 0) {
                        app.maxLineSize = res.data.maxLineSize;
                        app.lines = res.data.lines;

                        let columns = res.data.columns;
                        for (let i = 0; i < columns.length; i++) {
                            app.heads.push(columns[i].columnName);
                            app.columns.push({
                                label: columns[i].columnDesc,
                                value: columns[i].columnName,
                            });
                        }
                    }
                });
            },
            saveData: function () {
                if (!this.tmpFileName) {
                    this.$message.error('请上传文件');
                    return;
                }
                if (!this.tableId) {
                    this.$message.error('请选择数据表');
                    return;
                }

                var heads = {};
                for (let i = 0; i < this.heads.length; i++) {
                    var exist = heads[this.heads[i]];
                    if (exist || exist === 0) {
                        this.$message.error('第' + exist + '列和第' + i + '列表头重复');
                        return;
                    }
                    heads[this.heads[i]] = i;
                }

                this.fullscreenLoading = true;
                this.httpPost('data/saveData', {
                    tmpFileName: this.tmpFileName,
                    tableId: this.tableId,
                    split: this.split,
                    heads: heads
                }, function () {
                    app.maxLineSize = 0;
                    app.columns = [];
                    app.heads = [];
                    app.lines = [];
                    app.fullscreenLoading = false;
                }, function () {
                    app.fullscreenLoading = false;
                });
            }
        }
    })
</script>
</html>